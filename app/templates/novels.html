{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center page-header">
        <div>
            <h1 class="display-5 mb-0">Dystopian Novels</h1>
            <p class="text-muted mt-2 mb-0">Exploring dark futures and societal warnings</p>
        </div>
        <div class="d-none d-md-block">
            <div class="position-relative">
                <i class="bi bi-book-half" style="font-size: 2.5rem; opacity: 0.7;"></i>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <table id="novels_table" class="table table-striped table-hover" style="width:100%">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Published</th>
                    <th>Themes</th>
                    <th>Pages</th>
                    <th>Rating</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}

    <!-- Add the date diagnostic script -->
    <script>
    $(document).ready(function() {
        // Log data received from the server
        var originalAjaxSetup = $.ajaxSetup;
        $.ajaxSetup = function(options) {
            var originalSuccess = options && options.success;
            if (originalSuccess) {
                options.success = function(data) {
                    // Log the raw data from server for DataTables requests
                    if (data && data.data && Array.isArray(data.data)) {
                        console.log('First row from server:', data.data[0]);
                    }

                    // Call the original success handler
                    return originalSuccess.apply(this, arguments);
                };
            }
            return originalAjaxSetup.apply(this, arguments);
        };
    });
    </script>

    <script>
        $(function () {
            // Initialize Editor
            var editor = new $.fn.dataTable.Editor({
                ajax: function(method, url, data, success, error) {
                    // Prepare the URL based on the action
                    var action = data.action;
                    var ajaxUrl = '/api/editor/dystopianNovels';
                    var ids = [];

                    // Process dates before sending to server
                    if (action === 'create' || action === 'edit') {
                        // Loop through data objects
                        $.each(data.data, function(key, values) {
                            // Format the date if it exists and isn't already formatted
                            if (values.PublishedDate && values.PublishedDate.includes('T')) {
                                // Convert ISO format to YYYY-MM-DD
                                values.PublishedDate = values.PublishedDate.split('T')[0];
                            }
                        });
                    }

                    if (action === 'remove') {
                        // For remove, extract IDs from the data.id array
                        if (data.id && data.id.length > 0) {
                            ids = data.id;
                            console.log("Remove IDs:", ids);
                        } else if (data.data) {
                            // Alternative way to get IDs from selected rows
                            for (var id in data.data) {
                                if (data.data.hasOwnProperty(id)) {
                                    ids.push(id);
                                }
                            }
                            console.log("Remove IDs from data:", ids);
                        }

                        if (ids.length > 0) {
                            ajaxUrl += '?id=' + ids.join(',');
                        } else {
                            console.error("No IDs found for remove operation");
                        }
                    } else if (action === 'edit') {
                        // For edit, extract IDs from the data.data object keys
                        for (var id in data.data) {
                            if (data.data.hasOwnProperty(id)) {
                                ids.push(id);
                            }
                        }
                        if (ids.length > 0) {
                            ajaxUrl += '?id=' + ids.join(',');
                        }
                    }

                    // Log what we're sending (for debugging)
                    console.log('Editor ' + action + ' request:');
                    console.log('URL: ' + ajaxUrl);
                    console.log('Data:', data);

                    // Make the AJAX request
                    $.ajax({
                        url: ajaxUrl,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function(json) {
                            console.log('Success response:', json);
                            success(json);

                            // Reload the table to show the updated data
                            table.ajax.reload();
                        },
                        error: function(xhr, status, err) {
                            console.error('Error response:', xhr.responseText);
                            error(xhr, status, err);
                        }
                    });
                },
                table: '#novels_table',
                fields: [
                    {
                        label: "Title",
                        name: "Title",
                        type: "text"
                    },
                    {
                        label: "Author",
                        name: "Author",
                        type: "text"
                    },
                    {
                        label: "Published Date",
                        name: "PublishedDate",
                        type: "text",
                        attr: {
                            placeholder: "YYYY-MM-DD"
                        }
                    },
                    {
                        label: "Pages",
                        name: "Pages",
                        type: "text",
                        attr: {
                            type: "number"
                        }
                    },
                    {
                        label: "Themes",
                        name: "Themes",
                        type: "select",
                        multiple: true,
                        options: [
                            "Environmental collapse", "Surveillance state", "Artificial intelligence takeover",
                            "Post-apocalyptic survival", "Totalitarian government", "Corporate control",
                            "Biological warfare aftermath", "Digital consciousness", "Class warfare",
                            "Genetic engineering", "Mind control", "Resource depletion", "Technological dependence",
                            "Social media dystopia", "Reality manipulation", "Memory erasure", "Pandemic aftermath",
                            "Climate disaster", "Robotic revolution", "Virtual reality imprisonment"
                        ]
                    },
                    {
                        label: "Rating",
                        name: "Rating",
                        type: "select",
                        options: [
                            { label: "★★½ (2.5)", value: 2.5 },
                            { label: "★★★ (3.0)", value: 3.0 },
                            { label: "★★★½ (3.5)", value: 3.5 },
                            { label: "★★★★ (4.0)", value: 4.0 },
                            { label: "★★★★½ (4.5)", value: 4.5 },
                            { label: "★★★★★ (5.0)", value: 5.0 }
                        ]
                    },
                    {
                        label: "Description",
                        name: "Description",
                        type: "textarea"
                    }
                ]
            });

            // Handle edit form initialization to format dates
            editor.on('initEdit', function(e, node, data) {
                // Process the date field after the form is initialized
                if (data && data.PublishedDate) {
                    var dateVal = data.PublishedDate;

                    // Format the date if it's an ISO string
                    if (typeof dateVal === 'string' && dateVal.includes('T')) {
                        // Extract just the date part
                        var formattedDate = dateVal.split('T')[0];

                        // Update the field value
                        editor.field('PublishedDate').val(formattedDate);

                        console.log('Formatted date field to:', formattedDate);
                    }
                }
            });

            // Also handle preSubmit to ensure we have clean dates
            editor.on('preSubmit', function(e, data, action) {
                // Make sure dates are properly formatted before submission
                if (data.data) {
                    Object.keys(data.data).forEach(function(id) {
                        var rowData = data.data[id];
                        if (rowData.PublishedDate) {
                            // Ensure date is in YYYY-MM-DD format
                            if (rowData.PublishedDate.includes('T')) {
                                rowData.PublishedDate = rowData.PublishedDate.split('T')[0];
                            }
                        }
                    });
                }
            });

            // Initialize DataTable with simpler configuration
            var table = $('#novels_table').DataTable({
                dom: 'Bfrtip',
                serverSide: true,
                processing: true,
                pageLength: 10,
                select: true,
                rowId: 'DT_RowId',
                buttons: [
                    { extend: 'create', editor: editor },
                    { extend: 'edit', editor: editor },
                    { extend: 'remove', editor: editor }
                ],
                ajax: {
                    url: '/api/mongo/dystopianNovels',
                    type: 'POST',
                    contentType: 'application/json',
                    data: function (d) {
                        return JSON.stringify(d);
                    }
                },
                columns: [
                    { data: 'Title' },
                    { data: 'Author' },
                    {
                        data: 'PublishedDate',
                        className: 'dt-center',
                        render: function(data) {
                            if (!data) return '';

                            try {
                                var date = new Date(data);
                                return date.toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    day: 'numeric',
                                    month: 'long'
                                });
                            } catch (e) {
                                return data;
                            }
                        }
                    },
                    {
                        data: 'Themes',
                        render: function(data) {
                            if (!data) return '';
                            return Array.isArray(data) ? data.join(', ') : data;
                        }
                    },
                    { data: 'Pages' },
                    { data: 'Rating' }
                ]
            });

            // Event listeners for editor events
            editor
                .on('submitSuccess', function() {
                    // Force table reload after successful edit or delete
                    table.ajax.reload();
                })
                .on('submitComplete', function() {
                    // Another way to ensure table data is refreshed
                    table.ajax.reload();
                });
        });
    </script>

    <style>
        /* Custom styling specifically for this table view */
        tr.shown {
            background-color: rgba(63, 108, 255, 0.05) !important;
        }

        /* More compact table */
        .compact-table th,
        .compact-table td {
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
        }

        #novels_table tbody tr {
            cursor: pointer;
        }

        /* Date field styling */
        .DTE_Field input[name="PublishedDate"] {
            font-family: monospace;
            letter-spacing: 1px;
        }

        /* Format dates nicely in the table */
        .published-date {
            font-style: italic;
            color: #aaa;
        }
    </style>
{% endblock %}